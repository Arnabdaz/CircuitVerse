#!/bin/bash

# Delete server.pid if it exists
rm -f /circuitverse/tmp/pids/server.pid 2>&1

# Setup symbolic link for solargraph
if [ ! -d "${HOST_CURRENT_DIRECTORY%/*}" ]; then
  sudo mkdir -p "${HOST_CURRENT_DIRECTORY%/*}"
fi

if [ ! -L "$HOST_CURRENT_DIRECTORY" ]; then
  sudo ln -s -T /circuitverse "$HOST_CURRENT_DIRECTORY"
fi

# Run setup
echo "Setup project"
./bin/docker/setup
# Start solargraph server in background
bundle exec solargraph socket --host="0.0.0.0" --port=3002 &> /dev/null &
# Prompt user for start server
read -p "Start server? (y/n)" start_server
if [ "$start_server" != "${start_server#[Yy]}" ] ;then
    # Start server
    ./bin/dev
fi
# Start bash if previous command exits
/bin/bash